<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ass tits titan</title>
    <link rel="stylesheet" href="hologramStyle.css" />
  </head>
  <body>
    <button style="z-index: 4" id="playButton">Play Sound</button>

    <div class="buzz_wrapper">
      <div class="text">
        <span>
          <div id="imageContainer">
            <img id="mouth" src="mouth-closed.png" alt="Mouth Animation" />
          </div>
        </span>
      </div>
      <div class="scanline"></div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      // Audio setup
      const audio = new Audio("assets/output.mp3");
      const images = [
        "mouth-closed.png",
        "mouth-half-closed.png",
        "mouth-open.png",
      ];

      const imgElement = document.getElementById("mouth");
      const playButton = document.getElementById("playButton");

      // Web Audio API setup
      let audioCtx, analyser, dataArray;

      function setupAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;

        const source = audioCtx.createMediaElementSource(audio);
        source.connect(analyser);
        analyser.connect(audioCtx.destination);

        dataArray = new Uint8Array(analyser.frequencyBinCount);
      }

      // Function to update mouth animation
      function animateMouth() {
        if (!audioCtx || audio.paused) return;

        analyser.getByteFrequencyData(dataArray);

        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          sum += dataArray[i];
        }
        const avgVolume = sum / dataArray.length;

        // Choose the mouth image based on volume
        if (avgVolume < 50) {
          imgElement.src = images[0]; // Closed mouth
        } else if (avgVolume < 120) {
          imgElement.src = images[1]; // Half-open mouth
        } else {
          imgElement.src = images[2]; // Fully open mouth
        }

        requestAnimationFrame(animateMouth);
      }

      // Start audio and animation on button click
      playButton.addEventListener("click", () => {
        if (!audioCtx) {
          setupAudio();
        }

        audioCtx.resume().then(() => {
          audio.play();
          animateMouth();
        });
      });

      // Listen for the event from main.js to start audio
      ipcRenderer.on("start-audio", (event) => {
        if (!audioCtx) {
          setupAudio();
        }

        // Stop current audio
        audio.pause();
        audio.currentTime = 0;

        // Append a timestamp to bypass cache
        audio.src = `assets/output.mp3?t=${new Date().getTime()}`;
        audio.load(); // Forces the browser to reload the file

        audioCtx.resume().then(() => {
          audio.play();
          animateMouth();
        });
      });
    </script>
  </body>
</html>
